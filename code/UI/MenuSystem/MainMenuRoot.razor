@namespace Punt.UI
@using Sandbox.Menu
@using Sandbox.UI;
@using Sandbox.UI.Navigation;

@inherits NavigationHost



<root>

    <div class="navigator-canvas" slot="navigator-canvas" />

    <!-- Persistent UI elements that appear on all menu pages -->
    <div class="version-number">v0.1.0</div>

    <PartyDisplay />

    <WarningPanel />

    <!-- Footer that appears on all menu pages -->
    <div class="menu-footer">
        <!-- Left side: Page-specific buttons -->
        <div class="footer-left">
            <div class="footer-button" onclick=@ToggleChat>
                <span class="key-indicator">enter</span>
                Chat
            </div>

            @if (PageFooterButtons != null)
            {
                @PageFooterButtons
            }
        </div>

        <!-- Right side: Global buttons (chat, back/exit) -->
        <div class="footer-right">

            @if (CurrentUrl == "/")
            {
                <div class="footer-button" onclick=@ExitGame>
                    <span class="key-indicator">escape</span>
                    Exit
                </div>
            }
            else if (IsInLobby)
            {
                <div class="footer-button" onclick=@LeaveLobby>
                    <span class="key-indicator">escape</span>
                    Leave Lobby
                </div>
            }
            else
            {
                <div class="footer-button" onclick=@NavigateBack>
                    <span class="key-indicator">escape</span>
                    Back
                </div>
            }
        </div>
    </div>

@*     <MatchmakingStatus /> *@

</root>

@code
{
    public static MainMenuRoot Instance { get; set; }
    private bool isChatOpen = false;
    public RenderFragment PageFooterButtons { get; private set; }

    public MainMenuRoot()
    {
        Instance = this;
        DefaultUrl = "/";
        AddDestination("/", typeof(LandingPage));
        AddDestination("/play", typeof(Play));
        AddDestination("/BrowseCustomGames", typeof(BrowseCustomGames));
        AddDestination("/CreateGame", typeof(CreateCustomGame));
        AddDestination("/practise", typeof(Practise));
        AddDestination("/tutorial", typeof(Tutorial));
        AddDestination("/collection", typeof(Collection));
        AddDestination("/shop", typeof(Shop));
        AddDestination("/leaderboard", typeof(Leaderboard));

    }

    protected override void OnAfterTreeRender( bool firstTime )
    {
        base.OnAfterTreeRender( firstTime );

        if ( firstTime && NetworkManager.Instance != null )
        {
            NetworkManager.Instance.OnStateChanged += OnNetworkStateChanged;

            // Check if we're already in a lobby on startup (e.g., joined via Steam invite)
            if ( NetworkManager.Instance.CurrentState == NetworkState.InLobby )
            {
                Log.Info( "[MainMenuRoot] Already in lobby on startup - navigating to CreateGame page" );
                Navigate( "/CreateGame" );
            }
        }
    }

    private void OnNetworkStateChanged( NetworkState oldState, NetworkState newState )
    {
        Log.Info( $"[MainMenuRoot] Network state changed: {oldState} -> {newState}" );

        // Auto-navigate to CreateGame page when entering a lobby
        if ( newState == NetworkState.InLobby && oldState != NetworkState.InLobby )
        {
            Log.Info( "[MainMenuRoot] Entering lobby - navigating to CreateGame page" );
            Navigate( "/CreateGame" );
        }
        // Navigate back to home when leaving the lobby
        else if ( newState == NetworkState.None && oldState == NetworkState.InLobby )
        {
            Log.Info( "[MainMenuRoot] Left lobby - navigating to home page" );
            Navigate( "/" );
        }
    }

    private bool IsInLobby => NetworkManager.Instance?.CurrentState == NetworkState.InLobby;

    public void SetPageFooterButtons(RenderFragment buttons)
    {
        Log.Info("[MainMenuRoot] SetPageFooterButtons called");
        PageFooterButtons = buttons;
    }

    public void ClearPageFooterButtons()
    {
        Log.Info("[MainMenuRoot] ClearPageFooterButtons called");
        PageFooterButtons = null;
    }

    void NavigateBack()
    {
        GoBack();
    }

    void LeaveLobby()
    {
        Log.Info( "[MainMenuRoot] Leaving lobby" );
        NetworkManager.Instance?.LeaveLobby();
        // Navigation to home will happen automatically via OnNetworkStateChanged
    }

    void ToggleChat()
    {
        isChatOpen = !isChatOpen;
        // TODO: Implement chat panel visibility toggle
        Log.Info($"Chat toggled: {isChatOpen}");
    }

    void ExitGame()
    {
        Game.Close();
    }

    protected override int BuildHash()
    {
        return System.HashCode.Combine(
            base.BuildHash(),
            IsInLobby,
            PageFooterButtons?.GetHashCode() ?? 0,
            CurrentUrl
        );
    }
}

<style>
    @@import "/UI/Styles/punt.scss";
</style>

