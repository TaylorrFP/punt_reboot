@using System
@using Sandbox.Menu
@using Sandbox.UI;
@using Sandbox.UI.Navigation;
@using Sandbox.Network;
@using Sandbox.Modals;


@inherits Panel
@implements INavigatorPage
@namespace Punt.UI

<root class="main-menu create-custom-games-page @(IsDragging ? "is-dragging" : "")">
    <page-header>Create Game</page-header>

    <div class="content-panels">
        <div class="buttons-panel">

            <div class="button" onclick="@OnAddFriendClicked">
                <i>person_add_alt</i>
                <span>Add Friend</span>
            </div>

            <div class="button" onclick="@OnAddFriendClicked">
                <i>sports_esports</i>
                <span>Add Local Player</span>
            </div>


            <div class="button">
                <i>smart_toy</i>
                <span>Add Bot</span>
            </div>

            <div class="button">
                <i>settings</i>
                <span>Settings</span>
            </div>


        </div>
        <div class="main-content">
            <div class="game-panel panel">
                <div class="header-image-panel" style="background-image: url('ui/mainmenu/mapheaders/testmap_header.png');">
                    <div class="pitch-name">Test Map</div>
                </div>
                <div class="lobby-config-panel">
                    <div class="lobby-name-input @(IsInLobby ? "disabled" : "")">
                        <TextEntry @ref="LobbyNameInput" Text="@DisplayedLobbyName" Placeholder="Lobby Name" />
                    </div>

                    <div class="lobby-setting @(IsInLobby ? "disabled" : "")">
                        <span class="setting-label">Max Players</span>
                        <DropDown @ref="MaxPlayersDropdown" Options=@MaxPlayersOptions Value=@("4") />
                    </div>

                    <div class="lobby-setting @(IsInLobby ? "disabled" : "")">
                        <span class="setting-label">Privacy</span>
                        <DropDown @ref="PrivacyDropdown" Options=@PrivacyOptions Value=@("Public") />
                    </div>



                    <div class="create-lobby-button-container">
                        @if (IsInLobby && Networking.IsHost)
                        {
                            <div class="create-lobby-button start-game" onclick="@OnStartGameClicked">
                                Start Game
                            </div>
                        }
                        else if (!IsInLobby)
                        {
                            <div class="create-lobby-button" onclick="@OnCreateLobbyClicked">
                                Create Lobby
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="right-column">
                <div class="team-settings-panel panel">
                    <div class="teams-panel">
                        <div class="team-panel red" @ref="RedTeamPanel">
                            <div class="panel-header">Red Team</div>
                            <div class="team-slots">
                                @for (int i = 0; i < TeamSlotCount; i++)
                                {
                                    var slotIndex = i;
                                    var player = GetPlayerAtSlot(TeamSide.Red, slotIndex);
                                    var isOccupied = player.HasValue;
                                    var isBeingDragged = isOccupied && IsDragging && DraggedConnectionId == player.Value.ConnectionId;
                                    var isDropTarget = HighlightedTeam == TeamSide.Red && HighlightedSlotIndex == slotIndex;
                                    <div class="player-slot team-red @(isOccupied ? "occupied" : "empty") @(isBeingDragged ? "being-dragged" : "") @(isDropTarget ? "drop-target" : "")"
                                         onmousedown="@(() => { if (isOccupied) OnSlotMouseDown(player.Value.ConnectionId, player.Value.SteamId, player.Value.DisplayName, TeamSide.Red); })">
                                        @if (isOccupied)
                                        {
                                            <img src="avatar:@player.Value.SteamId" class="profile-picture" />
                                            <span class="player-name">@player.Value.DisplayName</span>
                                        }
                                        else
                                        {
                                            <span>Empty</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="vs-panel">
                            VS
                        </div>
                        <div class="team-panel blue" @ref="BlueTeamPanel">
                            <div class="panel-header">Blue Team</div>
                            <div class="team-slots">
                                @for (int i = 0; i < TeamSlotCount; i++)
                                {
                                    var slotIndex = i;
                                    var player = GetPlayerAtSlot(TeamSide.Blue, slotIndex);
                                    var isOccupied = player.HasValue;
                                    var isBeingDragged = isOccupied && IsDragging && DraggedConnectionId == player.Value.ConnectionId;
                                    var isDropTarget = HighlightedTeam == TeamSide.Blue && HighlightedSlotIndex == slotIndex;
                                    <div class="player-slot team-blue @(isOccupied ? "occupied" : "empty") @(isBeingDragged ? "being-dragged" : "") @(isDropTarget ? "drop-target" : "")"
                                         onmousedown="@(() => { if (isOccupied) OnSlotMouseDown(player.Value.ConnectionId, player.Value.SteamId, player.Value.DisplayName, TeamSide.Blue); })">
                                        @if (isOccupied)
                                        {
                                            <img src="avatar:@player.Value.SteamId" class="profile-picture" />
                                            <span class="player-name">@player.Value.DisplayName</span>
                                        }
                                        else
                                        {
                                            <span>Empty</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="spectators-panel panel" @ref="SpectatorPanel">
                    <div class="panel-header">Spectators</div>
                    <div class="spectator-slots">
                        @for (int i = 0; i < SpectatorSlotCount; i++)
                        {
                            var slotIndex = i;
                            var player = GetPlayerAtSlot(TeamSide.Spectator, slotIndex);
                            var isOccupied = player.HasValue;
                            var isBeingDragged = isOccupied && IsDragging && DraggedConnectionId == player.Value.ConnectionId;
                            var isDropTarget = HighlightedTeam == TeamSide.Spectator && HighlightedSlotIndex == slotIndex;
                            <div class="player-slot team-spectator @(isOccupied ? "occupied" : "empty") @(isBeingDragged ? "being-dragged" : "") @(isDropTarget ? "drop-target" : "")"
                                 onmousedown="@(() => { if (isOccupied) OnSlotMouseDown(player.Value.ConnectionId, player.Value.SteamId, player.Value.DisplayName, TeamSide.Spectator); })">
                                @if (isOccupied)
                                {
                                    <img src="avatar:@player.Value.SteamId" class="profile-picture" />
                                    <span class="player-name">@player.Value.DisplayName</span>
                                }
                                else
                                {
                                    <span>Empty</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (IsDragging)
    {
        <div class="dragged-player @GetDraggedTeamClass()" @ref="DraggedElement">
            <img src="avatar:@DraggedSteamId" class="profile-picture" />
            <span class="player-name">@DraggedDisplayName</span>
        </div>
    }
</root>

@code
{
    // ===================================================================================
    // LOBBY CONFIGURATION
    // ===================================================================================

    private TextEntry LobbyNameInput;
    private DropDown PrivacyDropdown;
    private DropDown MaxPlayersDropdown;
    private string DefaultLobbyName => $"{Connection.Local?.DisplayName ?? "Player"}'s Game";
    private bool IsInLobby => GameSession.Instance?.State == SessionState.CustomLobby;
    private string DisplayedLobbyName => IsInLobby ? GameSession.Instance?.LobbyName ?? DefaultLobbyName : DefaultLobbyName;

    private static List<Option> PrivacyOptions => new()
    {
        new Option( "Public", "Public" ),
        new Option( "Friends Only", "Friends Only" ),
        new Option( "Private", "Private" )
    };

    private static List<Option> MaxPlayersOptions => new()
    {
        new Option( "2", "2" ),
        new Option( "3", "3" ),
        new Option( "4", "4" ),
        new Option( "5", "5" ),
        new Option( "6", "6" ),
        new Option( "7", "7" ),
        new Option( "8", "8" ),
        new Option( "9", "9" ),
        new Option( "10", "10" ),
        new Option( "11", "11" ),
        new Option( "12", "12" )

    };

    private void OnAddFriendClicked()
    {

        var opts = new FriendsListModalOptions();

      


        Game.Overlay.ShowFriendsList( new FriendsListModalOptions() );
    }

    private void OnCreateLobbyClicked()
    {
        // Check if in a party and not the leader
        if (PartyRoom.Current != null && PartyRoom.Current.Owner.Id != Game.SteamId)
        {
            NotificationPanel.Show("Only the party leader can create a lobby",0.75f);
            return;
        }

        var lobbyName = LobbyNameInput?.Text ?? DefaultLobbyName;
        var maxPlayers = int.Parse( MaxPlayersDropdown?.Selected?.Value?.ToString() ?? "4" );
        var privacyValue = PrivacyDropdown?.Selected?.Value?.ToString() ?? "Public";

        var privacy = privacyValue switch
        {
            "Friends Only" => LobbyPrivacy.FriendsOnly,
            "Private" => LobbyPrivacy.Private,
            _ => LobbyPrivacy.Public
        };

        NetworkManager.Instance?.CreateLobby( maxPlayers, privacy, lobbyName );
    }

    private void OnStartGameClicked()
    {
        var session = GameSession.Instance;
        if (session == null) return;

        int redCount = session.GetTeamCount(TeamSide.Red);
        int blueCount = session.GetTeamCount(TeamSide.Blue);

        // Warn if either team is empty
        if (redCount == 0 || blueCount == 0)
        {
            ConfirmationDialog.Show(
                "Not all teams have players. Start Anyway?",
                "Yes",
                "Cancel",
                () => NetworkManager.Instance?.StartGame()
            );
            return;
        }

        NetworkManager.Instance?.StartGame();
    }

    // ===================================================================================
    // DRAG-AND-DROP PLAYER SLOT SYSTEM
    // ===================================================================================
    //
    // The UI renders directly from GameSession.TeamAssignments (the authoritative data).
    // Drag/drop simply calls AssignTeam() to update TeamAssignments, which triggers a
    // re-render via BuildHash. No local slot state is maintained.
    //
    // DRAG FLOW:
    // 1. OnSlotMouseDown: Start drag, store connection info for the floating element
    // 2. Tick: Update drag position and highlight target team panel
    // 3. OnMouseUp -> EndDrag(): Call AssignTeam() if dropping on different team
    // 4. BuildHash detects TeamAssignments change -> UI re-renders from new data
    // ===================================================================================

    // Constants for slot counts
    private const int TeamSlotCount = 5;
    private const int SpectatorSlotCount = 2;

    // Panel references for hit-testing
    private Panel RedTeamPanel;
    private Panel BlueTeamPanel;
    private Panel SpectatorPanel;

    // Drag state
    private bool IsDragging = false;
    private Guid DraggedConnectionId;
    private long DraggedSteamId;
    private string DraggedDisplayName;
    private TeamSide DragSourceTeam;
    private Vector2 DragPosition;
    private Panel DraggedElement;

    // Drop target highlighting
    private TeamSide? HighlightedTeam = null;
    private int? HighlightedSlotIndex = null;

    // Helper to get player at a specific slot index for a team
    private (Guid ConnectionId, long SteamId, string DisplayName)? GetPlayerAtSlot(TeamSide team, int slotIndex)
    {
        var teamAssignments = GameSession.Instance?.TeamAssignments;
        if (teamAssignments == null) return null;

        int currentIndex = 0;
        foreach (var kvp in teamAssignments)
        {
            if (kvp.Value == team)
            {
                if (currentIndex == slotIndex)
                {
                    var connection = Connection.All.FirstOrDefault(c => c.Id == kvp.Key);
                    var displayName = connection?.DisplayName ?? $"Player {kvp.Key}";
                    var steamId = connection?.SteamId ?? 0L;
                    return (kvp.Key, steamId, displayName);
                }
                currentIndex++;
            }
        }
        return null;
    }

    protected override void OnAfterTreeRender(bool firstTime)
    {
        base.OnAfterTreeRender(firstTime);
        UpdateDraggedElementPosition();
    }

    public void OnNavigationOpen() { }
    public void OnNavigationClose() { }

    private void OnSlotMouseDown(Guid connectionId, long steamId, string displayName, TeamSide sourceTeam)
    {
        IsDragging = true;
        DraggedConnectionId = connectionId;
        DraggedSteamId = steamId;
        DraggedDisplayName = displayName;
        DragSourceTeam = sourceTeam;
        DragPosition = Mouse.Position;
    }



    public override void Tick()
    {
        base.Tick();

        if (IsDragging)
        {
            DragPosition = Mouse.Position;
            UpdateDraggedElementPosition();

            // Update drop target highlighting
            HighlightedTeam = FindTeamUnderMouse();
            HighlightedSlotIndex = HighlightedTeam.HasValue ? GetFirstEmptySlotIndex(HighlightedTeam.Value) : null;
        }
    }

    protected override void OnMouseUp(MousePanelEvent e)
    {
        base.OnMouseUp(e);

        if (IsDragging)
        {
            //Log.Info("[DragDrop] Mouse released - ending drag");
            EndDrag();
        }
    }

    private void EndDrag()
    {
        var targetTeam = FindTeamUnderMouse();

        // Only update if dropping on a different team
        if (targetTeam.HasValue && targetTeam.Value != DragSourceTeam)
        {
            GameSession.Instance?.AssignTeam(DraggedConnectionId, targetTeam.Value);
        }

        IsDragging = false;
        HighlightedTeam = null;
        HighlightedSlotIndex = null;
    }

    private TeamSide? FindTeamUnderMouse()
    {
        Vector2 mousePos = Mouse.Position;

        if (IsMouseOverPanel(RedTeamPanel, mousePos))
            return TeamSide.Red;

        if (IsMouseOverPanel(BlueTeamPanel, mousePos))
            return TeamSide.Blue;

        if (IsMouseOverPanel(SpectatorPanel, mousePos))
            return TeamSide.Spectator;

        return null;
    }

    private bool IsMouseOverPanel(Panel panel, Vector2 mousePos)
    {
        if (panel == null) return false;

        var rect = panel.Box.Rect;
        return mousePos.x >= rect.Left && mousePos.x <= rect.Right &&
               mousePos.y >= rect.Top && mousePos.y <= rect.Bottom;
    }

    private int? GetFirstEmptySlotIndex(TeamSide team)
    {
        // If dragging within the same team, highlight the source slot (drop is a no-op)
        if (IsDragging && team == DragSourceTeam)
        {
            return GetSlotIndexForConnection(team, DraggedConnectionId);
        }

        int slotCount = team == TeamSide.Spectator ? SpectatorSlotCount : TeamSlotCount;
        for (int i = 0; i < slotCount; i++)
        {
            if (!GetPlayerAtSlot(team, i).HasValue)
                return i;
        }
        return null;
    }

    private int? GetSlotIndexForConnection(TeamSide team, Guid connectionId)
    {
        var teamAssignments = GameSession.Instance?.TeamAssignments;
        if (teamAssignments == null) return null;

        int currentIndex = 0;
        foreach (var kvp in teamAssignments)
        {
            if (kvp.Value == team)
            {
                if (kvp.Key == connectionId)
                    return currentIndex;
                currentIndex++;
            }
        }
        return null;
    }

    private void UpdateDraggedElementPosition()
    {
        if (DraggedElement == null || !IsDragging) return;

        // Convert screen position to panel space
        Vector2 panelPosition = ScaleFromScreen * DragPosition;

        DraggedElement.Style.Left = Length.Pixels(panelPosition.x);
        DraggedElement.Style.Top = Length.Pixels(panelPosition.y);
    }

    private string GetDraggedTeamClass()
    {
        return DragSourceTeam switch
        {
            TeamSide.Red => "team-red",
            TeamSide.Blue => "team-blue",
            TeamSide.Spectator => "team-spectator",
            _ => ""
        };
    }

    protected override int BuildHash()
    {
        var teamAssignments = GameSession.Instance?.TeamAssignments;
        int teamHash = 0;
        if (teamAssignments != null)
        {
            foreach (var kvp in teamAssignments)
            {
                teamHash = System.HashCode.Combine(teamHash, kvp.Key, kvp.Value);
            }
        }

        return System.HashCode.Combine(
            base.BuildHash(),
            IsDragging,
            DragPosition,
            HighlightedTeam,
            HighlightedSlotIndex,
            IsInLobby,
            Networking.IsHost,
            System.HashCode.Combine(teamHash, DisplayedLobbyName)
        );
    }
}
