@using Sandbox.Menu
@using Sandbox.UI;
@using Sandbox.UI.Navigation;
@using Sandbox.Network;
@using System;
@using Sandbox;
@inherits Panel
@implements INavigatorPage
@namespace Punt.UI

<root class="main-menu browse-custom-games-page">
    <page-header>Browse</page-header>

    <div class="game-browser">
        <div class="browser-header">
            <div class="column-name">Name</div>
            <div class="column-team-size">Teams</div>
            <div class="column-map">Current Map</div>
            <div class="column-ping">Ping</div>
            <div class="column-players">Players </div> @* WHY THE FUCK IS <i>person</i> NOT WORKING HERE *@
        </div>

        <div class="browser-list">
            @if ( IsSearching )
            {
                <div class="browser-message">Searching for lobbies...</div>
            }
            else if ( Lobbies.Count == 0 )
            {
                <div class="browser-message">No lobbies found</div>
            }
            else
            {
                @foreach ( var lobby in Lobbies )
                {
                    var isSelected = SelectedLobby.HasValue && SelectedLobby.Value.LobbyId == lobby.LobbyId;
                    <div class="browser-entry @(isSelected ? "selected" : "")" onclick="@(() => SelectLobby(lobby))" ondblclick="@(() => JoinLobby(lobby))">
                        <div class="column-name">@lobby.Name</div>
                        <div class="column-team-size">-</div>
                        <div class="column-map">@(lobby.Map ?? "Unknown")</div>
                        <div class="column-ping">-</div>
                        <div class="column-players">@lobby.Members / @lobby.MaxMembers</div>
                    </div>
                }
            }
        </div>
    </div>

</root>

@code
{
    private LobbyInformation? SelectedLobby;
    private bool _subscribedToEvents;

    protected override void OnAfterTreeRender( bool firstTime )
    {
        base.OnAfterTreeRender( firstTime );

        if ( firstTime && NetworkManager.Instance != null && !_subscribedToEvents )
        {
            NetworkManager.Instance.OnLobbiesUpdated += OnLobbiesUpdated;
            _subscribedToEvents = true;
        }
    }

    private void OnLobbiesUpdated()
    {
        StateHasChanged();
    }

    private IReadOnlyList<LobbyInformation> Lobbies => NetworkManager.Instance?.AvailableLobbies ?? Array.Empty<LobbyInformation>();
    private bool IsSearching => NetworkManager.Instance?.IsSearchingLobbies ?? false;

    public void OnNavigationOpen()
    {
        // Reset scroll position on the browser list
        var browserList = Descendants.FirstOrDefault(x => x.HasClass("browser-list"));
        if (browserList != null)
        {
            browserList.ScrollOffset = Vector2.Zero;
        }

        // Clear any existing page buttons first, then set this page's buttons
        MainMenuRoot.Instance?.ClearPageFooterButtons();

        MainMenuRoot.Instance?.SetPageFooterButtons(@<text>

            <div class="footer-button" onclick=@RefreshList>
                <span class="key-indicator">R</span>
                Refresh
            </div>

            <div class="footer-button" onclick=@JoinSelectedLobby>
                <span class="key-indicator">Enter</span>
                Join
            </div>

            <a class="footer-button" href="/CreateGame">
                <span class="key-indicator">C</span>
                Create
            </a>

        </text>);

        // Auto-refresh on open
        RefreshList();
    }

    public void OnNavigationClose()
    {
        // Clear page buttons when leaving this page
        MainMenuRoot.Instance?.ClearPageFooterButtons();

        // Unsubscribe from events
        if ( NetworkManager.Instance != null && _subscribedToEvents )
        {
            NetworkManager.Instance.OnLobbiesUpdated -= OnLobbiesUpdated;
            _subscribedToEvents = false;
        }
    }

    void RefreshList()
    {
        NetworkManager.Instance?.SearchLobbies();
    }

    void SelectLobby( LobbyInformation lobby )
    {
        SelectedLobby = lobby;
        StateHasChanged();
    }

    void JoinSelectedLobby()
    {
        if ( SelectedLobby.HasValue )
        {
            NetworkManager.Instance?.JoinLobby( SelectedLobby.Value );
        }
    }

    void JoinLobby( LobbyInformation lobby )
    {
        NetworkManager.Instance?.JoinLobby( lobby );
    }
}

