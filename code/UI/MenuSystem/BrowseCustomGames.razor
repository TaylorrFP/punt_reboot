@using Sandbox.Menu
@using Sandbox.UI;
@using Sandbox.UI.Navigation;
@using Sandbox.Network;
@using System;
@using Sandbox;
@inherits Panel
@implements INavigatorPage
@namespace Punt.UI

<root class="main-menu browse-custom-games-page">
    <page-header>Browse</page-header>

    <div class="game-browser">
        <div class="browser-header">
            <div class="column-name">Name</div>
            <div class="column-team-size">Teams</div>
            <div class="column-map">Current Map</div>
            <div class="column-ping">Ping</div>
            <div class="column-players">Players</div>
        </div>

        <div class="browser-list">
            @if ( IsSearching )
            {
                <div class="browser-message searching">
                    <div class="loading-spinner"></div>
                    <div>Searching for lobbies...</div>
                </div>
            }
            else if ( Lobbies.Count == 0 )
            {
                <div class="browser-message empty">No lobbies found 😢</div>
            }
            else
            {
                @foreach ( var lobby in Lobbies )
                {
                    var isSelected = SelectedLobby.HasValue && SelectedLobby.Value.LobbyId == lobby.LobbyId;
                    <div class="browser-entry @(isSelected ? "selected" : "")" onclick="@(() => SelectLobby(lobby))" ondblclick="@JoinSelectedLobby">
                        <div class="column-name">@lobby.Name</div>
                        <div class="column-team-size">-</div>
                        <div class="column-map">@(lobby.Map ?? "Unknown")</div>
                        <div class="column-ping">-</div>
                        <div class="column-players">@lobby.Members / @lobby.MaxMembers</div>
                    </div>
                }
            }
        </div>
    </div>

</root>

@code
{
    private LobbyInformation? SelectedLobby;
    private bool _subscribedToEvents;

    protected override void OnAfterTreeRender( bool firstTime )
    {
        base.OnAfterTreeRender( firstTime );

        if ( firstTime && NetworkManager.Instance != null && !_subscribedToEvents )
        {
            NetworkManager.Instance.OnLobbiesUpdated += OnLobbiesUpdated;
            _subscribedToEvents = true;
        }
    }

    private void OnLobbiesUpdated()
    {
        Log.Info($"[BrowseCustomGames] OnLobbiesUpdated called - Lobbies count: {Lobbies.Count}, IsSearching: {IsSearching}");
        // BuildHash will handle the rebuild automatically
    }

    private IReadOnlyList<LobbyInformation> Lobbies => NetworkManager.Instance?.AvailableLobbies ?? Array.Empty<LobbyInformation>();
    private bool IsSearching => NetworkManager.Instance?.IsSearchingLobbies ?? false;

    protected override int BuildHash()
    {
        return System.HashCode.Combine(
            base.BuildHash(),
            IsSearching,
            Lobbies.Count,
            SelectedLobby?.LobbyId ?? 0
        );
    }

    public void OnNavigationOpen()
    {
        Log.Info("[BrowseCustomGames] OnNavigationOpen called");

        // Clear any previous selection
        SelectedLobby = null;

        // Reset scroll position on the browser list
        var browserList = Descendants.FirstOrDefault(x => x.HasClass("browser-list"));
        if (browserList != null)
        {
            browserList.ScrollOffset = Vector2.Zero;
        }

        // Set footer buttons for this page (must happen after clearing selection)
        SetFooterButtons();

        // Auto-refresh on open
        RefreshList();
    }

    private void SetFooterButtons()
    {
        Log.Info("[BrowseCustomGames] Setting footer buttons");

        MainMenuRoot.Instance?.SetPageFooterButtons(@<text>

            <div class="footer-button" onclick=@RefreshList>
                <span class="key-indicator">R</span>
                Refresh
            </div>

            <a class="footer-button" href="/CreateGame">
                <span class="key-indicator">C</span>
                Create
            </a>

            @if (SelectedLobby.HasValue)
            {
                    <div class="footer-button" onclick=@JoinSelectedLobby>
                        <span class="key-indicator">Enter</span>
                        Join
                    </div>
            }

        </text>);
    }

    public void OnNavigationClose()
    {
        // Clear selection when leaving the page
        SelectedLobby = null;

        // Clear page buttons when leaving this page
        MainMenuRoot.Instance?.ClearPageFooterButtons();

        // Unsubscribe from events
        if ( NetworkManager.Instance != null && _subscribedToEvents )
        {
            NetworkManager.Instance.OnLobbiesUpdated -= OnLobbiesUpdated;
            _subscribedToEvents = false;
        }
    }

    void RefreshList()
    {
        NetworkManager.Instance?.SearchLobbies();
    }

    void SelectLobby( LobbyInformation lobby )
    {
        SelectedLobby = lobby;

        // Update footer buttons to show Join button
        SetFooterButtons();
    }

    void JoinSelectedLobby()
    {
        if ( SelectedLobby.HasValue )
        {
            NetworkManager.Instance?.JoinLobby( SelectedLobby.Value );
        }
    }
}

